deploy:
  runs-on: ubuntu-latest
  needs: build

  steps:
    - name: Checkout code           # добавили, чтобы git pull точно сработал
      uses: actions/checkout@v4

    - name: Install SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: Add server to known_hosts
      run: ssh-keyscan 82.97.253.187 >> ~/.ssh/known_hosts 2>/dev/null

    - name: Deploy to server
      run: |
        ssh -i ~/.ssh/id_rsa root@82.97.253.187 << 'EOF'
          cd /root/price_bot
          git pull origin master
        
          docker compose down --remove-orphans
          docker compose pull                  # обновим образы на сервере
          docker compose up --build -d
        
          docker image prune -f                # почистим старьё
        EOF